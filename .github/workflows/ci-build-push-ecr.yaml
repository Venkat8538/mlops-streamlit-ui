name: ci-build-push-ecr

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: mlops-streamlit-ui
  GITOPS_REPO: Venkat8538/platform-gitops
  GITOPS_REF: main
  GITOPS_VALUES_FILE: envs/dev/mlops-streamlit-ui-values.yaml

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug GitHub context
        run: |
          echo "Repository: ${{ github.repository }}"
          echo "Ref: ${{ github.ref }}"
          echo "Expected: repo:Venkat8538/mlops-streamlit-ui:ref:refs/heads/main"

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::482227257362:role/MLOps-github-actions-role
          aws-region: us-east-1
          role-session-name: GitHubActions-${{ github.run_id }}

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Compute image tag
        id: vars
        run: |
          echo "tag=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Build and push
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          IMAGE_URI="${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPOSITORY}:${{ steps.vars.outputs.tag }}"
          echo "Pushing: $IMAGE_URI"
          docker build -t "$IMAGE_URI" .
          docker push "$IMAGE_URI"

      - name: Checkout platform-gitops
        uses: actions/checkout@v4
        with:
          repository: ${{ env.GITOPS_REPO }}
          ref: ${{ env.GITOPS_REF }}
          token: ${{ secrets.GITOPS_TOKEN }}
          path: platform-gitops

      - name: Update image tag in platform-gitops (Helm values)
        working-directory: platform-gitops
        run: |
          set -euo pipefail
          VALUES_FILE="${GITOPS_VALUES_FILE}"
          NEW_TAG="${{ steps.vars.outputs.tag }}"

          if [ ! -f "$VALUES_FILE" ]; then
            echo "ERROR: values file not found: $VALUES_FILE"
            echo "Fix env.GITOPS_VALUES_FILE to the correct path in platform-gitops."
            exit 1
          fi

          python - <<'PY'
          import os, sys
          from pathlib import Path

          values_file = Path(os.environ["VALUES_FILE"])
          new_tag = os.environ["NEW_TAG"]

          txt = values_file.read_text(encoding="utf-8").splitlines(True)

          # Simple, safe-ish YAML line replacement for: tag: <something>
          # This assumes tag is under image: and appears as "tag: ..."
          out = []
          replaced = False
          for line in txt:
            if line.lstrip().startswith("tag:"):
              indent = line[:len(line) - len(line.lstrip())]
              out.append(f"{indent}tag: {new_tag}\n")
              replaced = True
            else:
              out.append(line)

          if not replaced:
            print(f"ERROR: Could not find a 'tag:' line in {values_file}", file=sys.stderr)
            sys.exit(2)

          values_file.write_text("".join(out), encoding="utf-8")
          print(f"Updated {values_file} -> tag: {new_tag}")
          PY
        env:
          VALUES_FILE: ${{ env.GITOPS_VALUES_FILE }}
          NEW_TAG: ${{ steps.vars.outputs.tag }}

      - name: Commit and push changes to platform-gitops
        working-directory: platform-gitops
        run: |
          set -euo pipefail
          git status --porcelain

          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "${GITOPS_VALUES_FILE}"
          git commit -m "Update mlops-streamlit-ui image tag to ${{ steps.vars.outputs.tag }}"
          git push origin "${GITOPS_REF}"
